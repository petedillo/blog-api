-- ============================================================================
-- Migration: V7__insert_sample_data.sql
-- Description: Insert sample blog post for development and testing
-- Author: Pete Dillo
-- Date: 2025-10-28
-- Note: This migration should only run in dev environment
-- ============================================================================

-- Insert sample featured blog post
INSERT INTO blog_posts (
    title,
    slug,
    content,
    excerpt,
    status,
    is_featured,
    published_at
) VALUES (
    'Sprint 1 Complete: Infrastructure Foundation',
    'sprint-1-infrastructure-foundation',
    E'# Sprint 1 Summary - Infrastructure Foundation\n\n**Sprint Duration**: November 14-17, 2025  \n**Status**: ✅ 100% COMPLETE  \n**Goal**: Build complete homelab infrastructure from zero to production-ready Kubernetes deployment\n\n---\n\n## Overview\n\nSprint 1 encompassed the complete foundation setup of the PeteDillo.com blog infrastructure, covering Phases 0-6. This sprint established all core infrastructure components needed for modern cloud-native application deployment.\n\n## Phases Completed\n\n### Phase 0: Planning ✅\n**Duration**: Nov 14, 2025  \n**Objective**: Network architecture and infrastructure planning\n\n**Key Deliverables**:\n- Network topology designed (192.168.50.0/24)\n- IP address scheme planned and documented\n- Service placement strategy defined\n- Hardware allocation plan (pedro: 40 cores/125GB RAM, pete: 4 cores/16GB RAM)\n\n---\n\n### Phase 1: Proxmox & Network Setup ✅\n**Duration**: Nov 14, 2025  \n**Objective**: Establish virtualization platform and network infrastructure\n\n**Key Achievements**:\n- Proxmox VE installed on 2-node cluster\n- Static IP configuration for all infrastructure nodes\n- SSH access configured\n- Storage configured for LXC containers and VMs\n- Ubuntu 22.04 LXC template downloaded\n\n**Network Configuration**:\n```\nProxmox Cluster:\n  pedro: 192.168.50.10 (40 cores, 125GB RAM)\n  pete: 192.168.50.11 (4 cores, 16GB RAM)\n\nServices:\n  Nexus LXC: 192.168.50.111\n  MicroK8s Node 1: 192.168.50.60\n  MicroK8s Node 2: 192.168.50.61\n\nGateway: 192.168.50.1\nSubnet: 192.168.50.0/24\n```\n\n---\n\n### Phase 2: Nexus Registry Setup ✅\n**Duration**: Nov 14, 2025  \n**Objective**: Deploy private container and Maven artifact registry\n\n**Key Achievements**:\n- LXC container created (VMID 106: 4 cores, 8GB RAM, 200GB disk)\n- Nexus 3.86.2-01 deployed via Docker Compose\n- Docker repositories configured (docker-local, docker-hub, docker-group)\n- Maven repositories configured (maven-releases, maven-snapshots, maven-public)\n- Deployment user created (github-actions) with ci-cd-deployer role\n- Automated snapshot cleanup configured (30-day retention)\n- Blob store compaction scheduled (daily at 3 AM)\n\n**Service Details**:\n```\nContainer: VMID 106 on pete (192.168.50.111)\nNexus Version: 3.86.2-01 Community\nUI: https://registry.toastedbytes.com\nDocker Registry: https://docker.toastedbytes.com\nDeployment User: github-actions (ci-cd-deployer role)\n```\n\n---\n\n### Phase 3: Cloudflare Tunnel Setup ✅\n**Duration**: Nov 14, 2025  \n**Objective**: Enable secure external access to internal services\n\n**Key Achievements**:\n- Cloudflare Tunnel created and configured\n- DNS records configured for all services\n- Free Universal SSL certificates (single-level subdomains)\n- External access verified and tested\n\n**Accessible Services**:\n```\nNexus UI: https://registry.toastedbytes.com\nDocker Registry: https://docker.toastedbytes.com\nArgoCD: https://argocd-dev.toastedbytes.com\nGrafana: https://grafana-dev.toastedbytes.com\nBlog (Dev): https://dev.petedillo.com\n```\n\n---\n\n### Phase 4: MicroK8s Cluster Setup ✅\n**Duration**: Nov 15, 2025  \n**Objective**: Deploy production-grade Kubernetes cluster\n\n**Key Achievements**:\n- 2 VMs created (k8s-node1 on pedro, k8s-node2 on pete)\n- Ubuntu 24.04 installed on both nodes\n- MicroK8s v1.32.9 deployed\n- Worker node joined to cluster\n- Add-ons enabled: dns, hostpath-storage, ingress, metrics-server, cert-manager\n- Kubeconfig exported to local machine\n- Cluster health verified\n\n**Cluster Details**:\n```\nKubernetes: v1.32.9\nNodes: 2 (1 control plane, 1 worker)\n\nk8s-node1 (Control Plane):\n  IP: 192.168.50.60\n  VM: 200 on pedro\n  Resources: 4 cores, 16GB RAM\n\nk8s-node2 (Worker):\n  IP: 192.168.50.61\n  VM: 201 on pete\n  Resources: 4 cores, 8GB RAM\n```\n\n---\n\n### Phase 5: ArgoCD & GitOps Setup ✅\n**Duration**: Nov 15-17, 2025  \n**Objective**: Implement GitOps workflow with CI/CD pipelines\n\n**Key Achievements**:\n- ArgoCD installed in argocd namespace\n- Ingress configured for external access\n- GitOps repository created (blog-gitops)\n- Sealed Secrets controller installed (v0.24.0)\n- All secrets encrypted and committed to git\n- Maven configuration with Nexus repositories\n- Dockerfile creation for API and UI\n- GitHub Actions workflows for CI/CD\n- Security hardening with least-privilege access\n- Semantic versioning implemented (0.1.0-SNAPSHOT)\n\n---\n\n### Phase 6: GitOps Deployment with API Gateway ✅\n**Duration**: Nov 17, 2025  \n**Objective**: Deploy blog applications using GitOps with unified domain architecture\n\n**Key Achievements**:\n- blog-gitops repository created on GitHub (public)\n- Sealed secrets applied to dev namespace\n- Kubernetes manifests created for PostgreSQL, Blog API, and Blog UI\n- ArgoCD application configured with automated sync\n- Deployment verified: PostgreSQL, Blog UI (2 replicas), Blog API (2 replicas)\n- Cloudflare Tunnel routes configured\n- Application testing successful\n\n**Architecture**: API Gateway Pattern\n```\nSingle Domain: dev.petedillo.com\nPath Routing:\n  / → Blog UI (React frontend)\n  /api/* → Blog API (Java Spring Boot backend)\n\nBenefits:\n  - No CORS issues\n  - Unified domain\n  - Simplified deployment\n  - Better security\n```\n\n---\n\n## Sprint 1 Metrics\n\n### Timeline\n- **Start Date**: November 14, 2025\n- **End Date**: November 17, 2025\n- **Duration**: 4 days\n- **Status**: 100% Complete\n\n### Deliverables\n- **Phases Completed**: 6 (Phase 0-6)\n- **Services Deployed**: 7 (Proxmox, Nexus, Cloudflare Tunnel, MicroK8s, ArgoCD, Blog API, Blog UI, PostgreSQL)\n- **Infrastructure Components**: 11 (2 Proxmox nodes, 1 LXC, 2 VMs, 6 Kubernetes services)\n- **Documentation Files**: 29 markdown files\n- **GitHub Repositories**: 3 (blog-api, blog-ui, blog-gitops)\n\n### Technical Achievements\n✅ Production-grade Kubernetes cluster (2 nodes)  \n✅ Private container registry with CI/CD integration  \n✅ GitOps workflow with ArgoCD  \n✅ Automated CI/CD pipelines (GitHub Actions)  \n✅ Secrets management (Sealed Secrets)  \n✅ External access via Cloudflare Tunnel  \n✅ API Gateway pattern for unified domain  \n✅ Persistent storage with automatic backups  \n✅ Security hardening (least-privilege access)  \n✅ Semantic versioning and artifact management\n\n---\n\n## Key Challenges & Solutions\n\n### Challenge 1: Docker Registry Path-Based URL\n**Issue**: Docker V2 API doesn''t support path-based registry URLs  \n**Solution**: Switched to subdomain routing (docker.toastedbytes.com) with Cloudflare free SSL\n\n### Challenge 2: Maven Deploy 403 Forbidden\n**Issue**: CI/CD user had insufficient permissions  \n**Solution**: Created custom ci-cd-deployer role with repository-specific privileges\n\n### Challenge 3: Nexus User Over-Privileged\n**Issue**: CI/CD user had nx-admin role (security risk)  \n**Solution**: Implemented least-privilege access with minimal required permissions\n\n### Challenge 4: ArgoCD Application Sync Issues\n**Issue**: Private repository authentication failing  \n**Solution**: Made blog-gitops public (contains only sealed secrets, safe to expose)\n\n### Challenge 5: CORS Issues with Multi-Domain Setup\n**Issue**: Browser blocking API calls from different origin  \n**Solution**: Implemented API Gateway pattern with unified domain and path-based routing\n\n### Challenge 6: API Pod Readiness Probe Failures\n**Issue**: Pod marked as not ready, causing traffic issues  \n**Solution**: Adjusted probe timing (60s liveness, 30s readiness delays)\n\n---\n\n## Lessons Learned\n\n1. **Subdomain routing is simpler** than path-based routing for Docker registries and avoids SSL certificate issues\n\n2. **Least-privilege access** prevents security incidents and should be configured from the start, not as an afterthought\n\n3. **API Gateway pattern** eliminates CORS issues and provides cleaner architecture than multiple subdomains\n\n4. **Sealed Secrets** work excellently with GitOps - allows committing encrypted secrets to public repos safely\n\n5. **Kustomize overlays** provide excellent flexibility for environment-specific configuration (dev/prod)\n\n6. **ArgoCD auto-sync** with prune and self-heal makes deployments truly hands-off once configured\n\n7. **Artifact-based Docker images** (JAR from Nexus) are faster to build than rebuilding source in Dockerfile\n\n8. **Semantic versioning from start** avoids confusion and enables clear versioning path to production releases\n\n9. **Documentation during development** is critical - easier than retroactive documentation\n\n10. **Automated cleanup tasks** (snapshots, blob store) prevent disk space issues before they happen\n\n---\n\n## Sprint 1 Success Criteria\n\n| Criteria | Target | Achieved | Status |\n|----------|--------|----------|--------|\n| Kubernetes cluster operational | 2 nodes | 2 nodes | ✅ |\n| Services externally accessible | All services | 7/7 services | ✅ |\n| CI/CD pipelines functional | API + UI | 2/2 pipelines | ✅ |\n| GitOps deployment working | ArgoCD syncing | Yes | ✅ |\n| Security hardening complete | Least privilege | Yes | ✅ |\n| Documentation complete | All phases | 6/6 phases | ✅ |\n| Application deployed | Blog running | Yes | ✅ |\n| Zero manual deployments | GitOps only | Yes | ✅ |\n\n**Overall Sprint 1 Success**: ✅ 100% (8/8 criteria met)\n\n---\n\n## Quick Reference - Sprint 1 Deliverables\n\n### Accessible Services\n```\nInfrastructure:\n  Nexus UI:         https://registry.toastedbytes.com\n  Docker Registry:  https://docker.toastedbytes.com\n  ArgoCD:           https://argocd-dev.toastedbytes.com\n  Grafana:          https://grafana-dev.toastedbytes.com\n\nApplications:\n  Blog UI:          https://dev.petedillo.com\n  Blog API:         https://dev.petedillo.com/api/\n  Health Check:     https://dev.petedillo.com/api/v1/health\n```\n\n### GitHub Repositories\n```\nAPI:         https://github.com/petedillo/blog-api\nUI:          https://github.com/petedillo/blog-ui\nGitOps:      https://github.com/petedillo/blog-gitops\n```\n\n### Infrastructure IPs\n```\nProxmox:\n  pedro:     192.168.50.10\n  pete:      192.168.50.11\n\nServices:\n  Nexus:     192.168.50.111\n  k8s-node1: 192.168.50.60\n  k8s-node2: 192.168.50.61\n\nGateway:     192.168.50.1\n```\n\n---\n\n## Conclusion\n\nSprint 1 successfully delivered a complete, modern cloud-native infrastructure from scratch in just 4 days. The foundation is production-ready, secure, and fully automated with GitOps workflows. All success criteria were met, and the infrastructure is now ready for enhanced observability and production planning in Sprint 2.\n\n**Key Achievement**: Zero-downtime deployments with GitOps, from code commit to production in minutes, fully automated.\n\n---\n\n**Sprint 1 Team**: Infrastructure Team  \n**Documentation**: 29 files, 368KB  \n**Completion Date**: November 17, 2025  \n**Status**: ✅ COMPLETE',
    'Building a complete homelab infrastructure from zero to production-ready Kubernetes deployment in 4 days.',
    'PUBLISHED',
    TRUE,
    CURRENT_TIMESTAMP
);

-- Get the ID of the inserted post
DO $$
DECLARE
    post_id BIGINT;
BEGIN
    SELECT id INTO post_id FROM blog_posts WHERE slug = 'sprint-1-infrastructure-foundation';

    -- Insert sample tags
    INSERT INTO blog_tags (blog_post_id, tag_name) VALUES
        (post_id, 'homelab'),
        (post_id, 'kubernetes'),
        (post_id, 'infrastructure'),
        (post_id, 'sprint-1');
END $$
;

-- Insert another sample post (draft)
INSERT INTO blog_posts (
    title,
    slug,
    content,
    excerpt,
    status,
    is_featured
) VALUES (
    'Phase 0: Planning the Infrastructure',
    'phase-0-planning-infrastructure',
    E'# Phase 0: Planning the Infrastructure\n\n**Duration**: November 14, 2025  \n**Objective**: Network architecture and infrastructure planning  \n**Status**: ✅ Complete\n\n---\n\n## Overview\n\nBefore building any infrastructure, proper planning is essential. Phase 0 focused on designing the network topology, IP addressing scheme, service placement strategy, and hardware allocation for the entire homelab infrastructure.\n\n---\n\n## Network Design\n\n### Network Topology\n\nThe homelab network operates on a single subnet with clear IP allocation for different service types:\n\n```\nSubnet: 192.168.50.0/24\nGateway: 192.168.50.1\nUsable IPs: 192.168.50.1 - 192.168.50.254\n```\n\n### IP Address Scheme\n\n**Infrastructure Nodes (10-19)**:\n- `192.168.50.10` - pedro (Proxmox host 1)\n- `192.168.50.11` - pete (Proxmox host 2)\n\n**Kubernetes Cluster (60-69)**:\n- `192.168.50.60` - k8s-node1 (control plane)\n- `192.168.50.61` - k8s-node2 (worker node)\n\n**Services (100-119)**:\n- `192.168.50.111` - Nexus Registry (LXC container)\n\n**Reserved for Future Use**:\n- `192.168.50.20-59` - Additional infrastructure\n- `192.168.50.70-99` - Additional Kubernetes nodes\n- `192.168.50.120-199` - Additional services\n\n---\n\n## Hardware Allocation\n\n### Proxmox Host: pedro\n```\nCPU: 40 cores\nRAM: 125 GB\nRole: Primary compute node\nWorkloads:\n  - k8s-node1 (control plane): 4 cores, 16GB RAM\n  - Additional VMs and containers as needed\n```\n\n### Proxmox Host: pete\n```\nCPU: 4 cores\nRAM: 16 GB\nRole: Secondary compute node\nWorkloads:\n  - Nexus LXC: 4 cores, 8GB RAM, 200GB disk\n  - k8s-node2 (worker): 4 cores, 8GB RAM\n```\n\n**Total Resources**:\n- Combined CPU: 44 cores\n- Combined RAM: 141 GB\n- High availability: 2-node cluster\n\n---\n\n## Service Placement Strategy\n\n### Virtualization Layer\n- **Platform**: Proxmox VE\n- **Cluster**: 2-node HA cluster\n- **Storage**: Local storage on each node\n- **Networking**: Bridged networking for VMs/containers\n\n### Container Registry\n- **Service**: Nexus Repository Manager\n- **Deployment**: LXC container on pete\n- **Resources**: 4 cores, 8GB RAM, 200GB disk\n- **Repositories**:\n  - Docker registry (local, hub proxy, group)\n  - Maven registry (releases, snapshots, public)\n\n### Kubernetes Cluster\n- **Distribution**: MicroK8s\n- **Nodes**: 2 (1 control plane + 1 worker)\n- **Add-ons**: dns, hostpath-storage, ingress, metrics-server, cert-manager\n- **Load Balancing**: NGINX Ingress Controller\n\n### External Access\n- **Method**: Cloudflare Tunnel\n- **SSL/TLS**: Cloudflare Universal SSL (free)\n- **Domains**:\n  - `toastedbytes.com` - Infrastructure services\n  - `petedillo.com` - Blog application\n\n### GitOps & CI/CD\n- **GitOps**: ArgoCD deployed in Kubernetes\n- **Secrets**: Sealed Secrets controller\n- **CI/CD**: GitHub Actions\n- **Artifact Storage**: Nexus Repository\n\n---\n\n## Architecture Decisions\n\n### 1. Single Subnet Design\n**Decision**: Use a single `/24` subnet for all services  \n**Rationale**:\n- Simplifies routing and firewall rules\n- Easier to manage for small-scale homelab\n- No need for VLAN complexity initially\n- Can segment later if needed\n\n### 2. LXC vs VM for Nexus\n**Decision**: Deploy Nexus in LXC container  \n**Rationale**:\n- Lower resource overhead than VM\n- Sufficient isolation for private network\n- Easier to manage and backup\n- Better performance for I/O operations\n\n### 3. MicroK8s vs K3s\n**Decision**: Use MicroK8s for Kubernetes  \n**Rationale**:\n- Canonical support and long-term maintenance\n- Comprehensive add-on ecosystem\n- Production-grade features\n- Easier multi-node clustering\n\n### 4. Cloudflare Tunnel vs Port Forwarding\n**Decision**: Use Cloudflare Tunnel for external access  \n**Rationale**:\n- No port forwarding required\n- Free SSL/TLS certificates\n- DDoS protection included\n- Hides home IP address\n- Better security posture\n\n### 5. API Gateway Pattern\n**Decision**: Unified domain with path-based routing  \n**Rationale**:\n- Eliminates CORS issues\n- Simpler SSL certificate management\n- Better user experience (single domain)\n- Cleaner architecture\n\n---\n\n## Technology Stack\n\n### Infrastructure Layer\n- **Hypervisor**: Proxmox VE\n- **Container Platform**: Docker (for Nexus)\n- **Orchestration**: MicroK8s (Kubernetes v1.32+)\n\n### Application Layer\n- **Frontend**: React with Tailwind CSS\n- **Backend**: Spring Boot 3 (Java 21)\n- **Database**: PostgreSQL 15\n\n### DevOps Tools\n- **GitOps**: ArgoCD\n- **CI/CD**: GitHub Actions\n- **Secrets Management**: Sealed Secrets\n- **Container Registry**: Nexus Repository Manager\n- **Maven Repository**: Nexus Repository Manager\n\n### Networking & Security\n- **Ingress**: NGINX Ingress Controller\n- **External Access**: Cloudflare Tunnel\n- **SSL/TLS**: Cloudflare Universal SSL\n- **DNS**: Cloudflare DNS\n\n### Observability (Planned)\n- **Metrics**: Prometheus\n- **Visualization**: Grafana\n- **Logging**: Loki\n- **Tracing**: Tempo (future)\n\n---\n\n## Implementation Phases\n\nThe planning phase defined the following implementation roadmap:\n\n1. **Phase 1**: Proxmox & Network Setup\n2. **Phase 2**: Nexus Registry Setup\n3. **Phase 3**: Cloudflare Tunnel Setup\n4. **Phase 4**: MicroK8s Cluster Setup\n5. **Phase 5**: ArgoCD & GitOps Setup\n6. **Phase 6**: Application Deployment\n7. **Phase 7**: Observability & Monitoring\n8. **Phase 8**: Production Readiness\n\n---\n\n## Success Criteria\n\nThe following criteria were defined for successful infrastructure deployment:\n\n- ✅ All services accessible via HTTPS\n- ✅ Automated deployments via GitOps\n- ✅ Zero manual configuration after initial setup\n- ✅ Secrets encrypted and managed securely\n- ✅ CI/CD pipelines functional\n- ✅ High availability for critical services\n- ✅ Comprehensive documentation\n\n---\n\n## Key Planning Decisions Summary\n\n| Decision Area | Choice | Rationale |\n|--------------|--------|----------|\n| **Network** | Single /24 subnet | Simplicity, ease of management |\n| **Hypervisor** | Proxmox VE | Open source, mature, feature-rich |\n| **Kubernetes** | MicroK8s | Canonical support, production-grade |\n| **Registry** | Nexus (LXC) | All-in-one Docker + Maven |\n| **External Access** | Cloudflare Tunnel | Security, free SSL, DDoS protection |\n| **GitOps** | ArgoCD | Industry standard, robust features |\n| **Secrets** | Sealed Secrets | Git-compatible encryption |\n| **CI/CD** | GitHub Actions | Native GitHub integration |\n| **Architecture** | API Gateway | No CORS, unified domain |\n\n---\n\n## Conclusion\n\nPhase 0 successfully established a comprehensive infrastructure plan with clear technical decisions, resource allocation, and implementation phases. This planning phase ensured smooth execution of subsequent phases and avoided common pitfalls that arise from insufficient upfront planning.\n\n**Next Phase**: [Phase 1 - Proxmox & Network Setup]\n\n---\n\n**Planning Date**: November 14, 2025  \n**Status**: ✅ Complete  \n**Documentation**: Network topology diagrams, IP allocation tables, architecture decision records',
    'Network architecture and infrastructure planning for the PeteDillo.com blog homelab.',
    'DRAFT',
    FALSE
);

-- Get the draft post ID and add tags
DO $$
DECLARE
    post_id BIGINT;
BEGIN
    SELECT id INTO post_id FROM blog_posts WHERE slug = 'phase-0-planning-infrastructure';

    INSERT INTO blog_tags (blog_post_id, tag_name) VALUES
        (post_id, 'planning'),
        (post_id, 'network-design'),
        (post_id, 'homelab'),
        (post_id, 'proxmox');
END $$
;
